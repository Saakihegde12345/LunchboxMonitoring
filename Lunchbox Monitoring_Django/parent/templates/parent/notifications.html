{% extends "parent/base.html" %}

{% block title %}Notifications - Parent Portal{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'parent:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Notifications</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Notifications</h1>
    <div>
        <form method="post" action="{% url 'parent:mark_all_read' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-check-all me-1"></i> Mark all as read
            </button>
        </form>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        {% if notifications %}
        <div class="list-group list-group-flush">
            {% for notification in notifications %}
            <a href="#" class="list-group-item list-group-item-action {% if not notification.is_read %}bg-light{% endif %}" 
               data-notification-id="{{ notification.id }}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        {% if notification.notification_type == 'food_eaten' %}
                        <i class="bi bi-emoji-smile-fill text-success me-2"></i>
                        {% elif notification.notification_type == 'food_spoiled' %}
                        <i class="bi bi-emoji-frown-fill text-danger me-2"></i>
                        {% elif notification.notification_type == 'temperature_alert' %}
                        <i class="bi bi-thermometer-high text-warning me-2"></i>
                        {% else %}
                        <i class="bi bi-bell-fill text-primary me-2"></i>
                        {% endif %}
                        {{ notification.title }}
                    </h6>
                    <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                </div>
                <p class="mb-1">{{ notification.message }}</p>
                <small class="text-muted">
                    {{ notification.get_notification_type_display }}
                    {% if notification.lunchbox_id %}
                     â€¢ Lunchbox #{{ notification.lunchbox_id }}
                    {% endif %}
                </small>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info m-3">
            <i class="bi bi-bell-slash me-2"></i>No notifications to display.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Mark notification as read when clicked
$(document).on('click', '[data-notification-id]', function(e) {
    e.preventDefault();
    const notificationId = $(this).data('notification-id');
    
    // Mark as read via AJAX
    $.ajax({
        url: `/parent/notifications/mark-read/${notificationId}/`,
        method: 'POST',
        headers: {
            'X-CSRFTTOKEN': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function() {
            // Remove highlight and update unread count
            $(`[data-notification-id="${notificationId}"]`).removeClass('bg-light');
            updateUnreadCount();
        }
    });
});

// Update unread count in navbar
function updateUnreadCount() {
    $.ajax({
        url: '{% url "parent:notification_count" %}',
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(data) {
            const count = data.count;
            const $badge = $('.notification-badge');
            
            if (count > 0) {
                $badge.text(count).show();
            } else {
                $badge.hide();
            }
        }
    });
}

// Check for new notifications every 30 seconds
setInterval(updateUnreadCount, 30000);
</script>
{% endblock %}

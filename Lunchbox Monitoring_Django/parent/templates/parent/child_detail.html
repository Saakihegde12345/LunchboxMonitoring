{% extends "parent/base.html" %}

{% block title %}{{ child.name }}'s Lunchbox - Parent Portal{% endblock %}

{% block extra_css %}
<style>
    .sensor-card {
        transition: transform 0.2s;
    }
    .sensor-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    .sensor-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .sensor-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'parent:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ child.name }}'s Lunchbox</li>
    </ol>
</nav>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ child.name }}'s Lunchbox</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
        </div>
    </div>
</div>

{% if not lunchbox %}
<div class="alert alert-warning">
    <h4 class="alert-heading">No Lunchbox Assigned</h4>
    <p>This child doesn't have a lunchbox assigned yet. Please contact support to assign a lunchbox.</p>
</div>
{% else %}
<!-- Sensor Data Overview -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="card h-100 sensor-card">
            <div class="card-body text-center">
                <div class="sensor-icon text-danger">
                    <i class="bi bi-thermometer-half"></i>
                </div>
                <h5 class="card-title">Temperature</h5>
                <div class="sensor-value">
                    {% if temperature_readings %}
                        {{ temperature_readings.last.temperature|floatformat:1 }}째C
                    % else %}
                        --
                    {% endif %}
                </div>
                <p class="text-muted mb-0">
                    {% if temperature_readings %}
                        Last updated {{ temperature_readings.last.timestamp|timesince }} ago
                    {% else %}
                        No data available
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card h-100 sensor-card">
            <div class="card-body text-center">
                <div class="sensor-icon text-info">
                    <i class="bi "
                       {% if food_consumption and food_consumption.weight_grams < 100 %}
                           bi-emoji-frown
                       {% else %}
                           bi-emoji-smile
                       {% endif %}
                    ></i>
                </div>
                <h5 class="card-title">Food Status</h5>
                <div class="sensor-value">
                    {% if food_consumption %}
                        {% if food_consumption.weight_grams < 100 %}
                            Eaten
                        {% else %}
                            Available
                        {% endif %}
                    {% else %}
                        --
                    {% endif %}
                </div>
                <p class="text-muted mb-0">
                    {% if food_consumption %}
                        {{ food_consumption.weight_grams }}g remaining
                    {% else %}
                        No data available
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="card h-100 sensor-card">
            <div class="card-body text-center">
                <div class="sensor-icon text-warning">
                    <i class="bi bi-battery-half"></i>
                </div>
                <h5 class="card-title">Battery Level</h5>
                <div class="sensor-value">
                    {% if lunchbox.battery_level %}
                        {{ lunchbox.battery_level }}%
                    {% else %}
                        --
                    {% endif %}
                </div>
                <div class="progress mt-2" style="height: 10px;">
                    <div class="progress-bar bg-warning" role="progressbar" 
                         style="width: {{ lunchbox.battery_level|default:0 }}%;" 
                         aria-valuenow="{{ lunchbox.battery_level|default:0 }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100"></div>
                </div>
                <p class="text-muted mb-0 mt-2">
                    {% if lunchbox.last_charged %}
                        Last charged {{ lunchbox.last_charged|timesince }} ago
                    {% else %}
                        Charging status unknown
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Temperature Chart -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Temperature History (Last 24 Hours)</h5>
    </div>
    <div class="card-body">
        {% if temperature_readings %}
        <canvas id="temperatureChart" height="300"></canvas>
        {% else %}
        <div class="alert alert-info mb-0">
            No temperature data available for the last 24 hours.
        </div>
        {% endif %}
    </div>
</div>

<!-- Recent Alerts -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Recent Alerts</h5>
        <a href="{% url 'parent:notifications' %}" class="btn btn-sm btn-outline-primary">View All</a>
    </div>
    <div class="card-body p-0">
        {% if alerts %}
        <div class="list-group list-group-flush">
            {% for alert in alerts %}
            <div class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        <i class="bi bi-{% if alert.severity == 'HIGH' %}exclamation-triangle-fill text-danger{% else %}info-circle-fill text-info{% endif %} me-2"></i>
                        {{ alert.get_severity_display }} Alert
                    </h6>
                    <small class="text-muted">{{ alert.timestamp|timesince }} ago</small>
                </div>
                <p class="mb-1">{{ alert.message }}</p>
                <small class="text-muted">Lunchbox #{{ alert.lunchbox_id }}</small>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-info m-3">
            <i class="bi bi-check-circle me-2"></i>No recent alerts for this lunchbox.
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if temperature_readings %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Temperature Chart
const ctx = document.getElementById('temperatureChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for reading in temperature_readings %}
                '{{ reading.timestamp|time:"H:i" }}'{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            label: 'Temperature (째C)',
            data: [
                {% for reading in temperature_readings %}
                    {{ reading.temperature|floatformat:1 }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Temperature (째C)'
                }
            },
            x: {
                title: {
                    display: true,
                    text: 'Time'
                }
            }
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toFixed(1) + '째C';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}

<script>
// Auto-refresh the page every 5 minutes
setTimeout(function() {
    window.location.reload();
}, 300000);
</script>
{% endblock %}
